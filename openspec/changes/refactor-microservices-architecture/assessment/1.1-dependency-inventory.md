# 1.1 Auth & AI Dependency Inventory

## Auth Service Dependencies

### Endpoints (`backend/src/api/endpoints/auth.py`)

| Method | Path                 | Description                            | Auth Required |
| ------ | -------------------- | -------------------------------------- | ------------- |
| POST   | `/auth/register`     | Register new user + auto-join #general | No            |
| POST   | `/auth/login`        | Login via OAuth2 form + set JWT cookie | No            |
| GET    | `/auth/me`           | Get current user profile               | Yes           |
| GET    | `/auth/users/{id}`   | Get user by ID                         | No            |
| PUT    | `/auth/me`           | Update display name / avatar           | Yes           |
| GET    | `/auth/users/search` | Search users by name                   | Yes           |

### Models

| Model        | File                               | Columns Used by Auth                                                                                                                      |
| ------------ | ---------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------- |
| `User`       | `backend/src/models/user.py`       | `id`, `username`, `display_name`, `password_hash`, `status`, `profile_picture_url`, `display_name_updated_at`, `created_at`, `updated_at` |
| `Channel`    | `backend/src/models/channel.py`    | `id`, `name`, `type` (used in register/login to ensure #general exists)                                                                   |
| `Membership` | `backend/src/models/membership.py` | `user_id`, `channel_id` (auto-join #general on register/login)                                                                            |

### Configuration (`backend/src/core/config.py`)

| Setting                       | Default                  | Used By           |
| ----------------------------- | ------------------------ | ----------------- |
| `SECRET_KEY`                  | `"your-secret-key-here"` | JWT encode/decode |
| `ALGORITHM`                   | `"HS256"`                | JWT encode/decode |
| `ACCESS_TOKEN_EXPIRE_MINUTES` | `30`                     | Token expiry      |
| `DATABASE_URL`                | `"sqlite:///./chat.db"`  | SQLAlchemy engine |

### Internal Imports

| Import                      | Source                    | Purpose                             |
| --------------------------- | ------------------------- | ----------------------------------- |
| `settings`                  | `src.core.config`         | Config values                       |
| `get_db`                    | `src.core.database`       | DB session dependency               |
| `User`                      | `src.models.user`         | ORM model                           |
| `Channel`                   | `src.models.channel`      | Auto-join #general                  |
| `Membership`                | `src.models.membership`   | Auto-join #general                  |
| `log_join`, `log_nick_user` | `src.services.irc_logger` | IRC-style logging on register/login |

### Third-Party Libraries

| Package              | Purpose                        |
| -------------------- | ------------------------------ |
| `fastapi`            | Router, Depends, HTTPException |
| `sqlalchemy`         | ORM session, query             |
| `python-jose`        | JWT encode/decode              |
| `passlib` + `bcrypt` | Password hashing (bcrypt)      |
| `pydantic`           | Request/response models        |
| `hashlib` (stdlib)   | SHA-256 fallback hashing       |

### Cross-Domain Coupling

- **#general channel auto-join**: Register and login both query/create `Channel` and `Membership`. This couples auth to the channel domain.
- **IRC logger**: `log_nick_user()` and `log_join()` called on register/login. Logging-only dependency; can be replicated or removed.
- **`get_current_user()` used by other endpoints**: AI, channels, game, media, and data-processor endpoints all depend on `get_current_user` from auth. This is the primary shared dependency across the monolith.

---

## AI Service Dependencies

### Endpoints (`backend/src/api/endpoints/ai.py`)

| Method | Path               | Description                            | Auth Required |
| ------ | ------------------ | -------------------------------------- | ------------- |
| POST   | `/ai/query`        | Non-streaming AI query (returns JSON)  | Yes           |
| POST   | `/ai/query/stream` | Streaming AI query (returns SSE)       | Yes           |
| GET    | `/ai/status`       | AI availability + remaining rate-limit | Yes           |

### Models

| Model  | File                 | Usage                               |
| ------ | -------------------- | ----------------------------------- |
| `User` | `src/models/user.py` | `current_user.id` for rate limiting |

### Configuration (`backend/src/core/config.py`)

| Setting                  | Default                       | Used By                |
| ------------------------ | ----------------------------- | ---------------------- |
| `ANTHROPIC_API_KEY`      | `""` (empty)                  | Claude HTTP calls      |
| `CLAUDE_MODEL`           | `"claude-3-haiku-20240307"`   | Model selection        |
| `ANTHROPIC_API_BASE`     | `"https://api.anthropic.com"` | API base URL           |
| `AI_RATE_LIMIT_PER_HOUR` | `10`                          | In-memory rate limiter |

### Internal Imports

| Import             | Source                            | Purpose                          |
| ------------------ | --------------------------------- | -------------------------------- |
| `settings`         | `src.core.config`                 | Config values                    |
| `get_db`           | `src.core.database`               | DB session (passed but unused?)  |
| `User`             | `src.models.user`                 | Type hint for `current_user`     |
| `get_current_user` | `src.api.endpoints.auth`          | Auth dependency (JWT validation) |
| `orchestrator`     | `src.services.agent_orchestrator` | AI agent logic                   |

### Services (`backend/src/services/agent_orchestrator.py`)

| Class               | Methods                                      | External Calls                     |
| ------------------- | -------------------------------------------- | ---------------------------------- |
| `AgentOrchestrator` | `process_query()`, `stream_judge_response()` | Anthropic Messages API via `httpx` |

The orchestrator uses `httpx.AsyncClient` to call the Anthropic API directly (no SDK). It runs 2 specialist agents (FinanceBot, LearnBot) in parallel, then a JudgeBot to synthesize.

### Third-Party Libraries

| Package    | Purpose                        |
| ---------- | ------------------------------ |
| `fastapi`  | Router, Depends, HTTPException |
| `pydantic` | Request/response schemas       |
| `httpx`    | Async HTTP client for Claude   |

### Cross-Domain Coupling

- **Auth dependency**: AI endpoints use `get_current_user` from auth for JWT validation. This is the strongest coupling point.
- **In-memory rate limiting**: `_rate_limit_store` is a module-level dict. Not shared across workers/pods. Must be replaced with Redis.
- **No admin allowlist**: Currently no check for admin-only access. All authenticated users can use AI. The `ADMIN_ALLOWLIST` enforcement is a new requirement.

---

## Shared Infrastructure

| Component         | File                           | Used By                              |
| ----------------- | ------------------------------ | ------------------------------------ |
| SQLAlchemy engine | `backend/src/core/database.py` | Auth (direct), AI (via `get_db` dep) |
| Settings          | `backend/src/core/config.py`   | Auth + AI                            |
| `Base` (ORM base) | `backend/src/core/database.py` | All models                           |

## Router Registration (`backend/src/main.py`)

```python
app.include_router(auth_router)   # /auth/*
app.include_router(ai_router)     # /ai/*
```

Both routers are registered on the monolith FastAPI app alongside channels, media, game, and data-processor routers.

## External Service Consumers of Auth

| Service        | How it uses Auth                                              |
| -------------- | ------------------------------------------------------------- |
| media-storage  | Calls `GET /auth/me` to verify JWT (via `BACKEND_VERIFY_URL`) |
| frontend       | Sends JWT cookie with every request                           |
| data-processor | Calls backend URL (indirect auth dependency)                  |
